# 持续交付流水线参数字典

## 一、简述

​		持续交付流水线使用Jenkins集成pipeline插件，基于code as pipeline的理念，将持续交付持续构建过程变成脚本化的代码。对应软件开发的过程，设置了开发（dev）、测试（test）、发布（release）、生产（production）四条流水线。   

​		本文档旨在说明流水线配置参数的含义及配置方法。     

## 二、参数说明

### 2.1 流水线参数（/cicd-config）

#### 2.1.1 流水线类型参数

##### （1）PP_TYPE 
【参数说明】流水线类型  
【使用指导】  
  1）现阶段支持开发（dev）、测试（test）、发布（release）和生产（production）四条流水线；   
  2）使用预置默认值，不可修改。  

#### 2.1.2 项目仓库参数  

##### （2）项目源码库参数    
* **PJ_URL**：执行部署的项目源码仓库地址，格式为：http://[ip:port]/url.git;  
* **PJ_BRANCH**：执行部署的项目源码分支；  
* **PJ_KEY**：从项目仓库获取代码的凭据ID，在持续交付中心“凭据管理”中配置，此处为凭据的ID。   

##### （3）测试用例库（cicd-test）参数
* **TEST_SH_URL**：后端项目测试脚本及测试用例（cicd-test）地址。如果是前端项目，不填。格式为：http://[ip:port]/url.git；
* **TEST_SH_BRANCH**：测试脚本及测试用例项目仓库的分支；
* **TEST_SH_KEY**：从项目仓库获取测试用例代码的凭据ID，在持续交付中心“凭据管理”中配置，此处为凭据的ID。

#### 2.1.3 部署环境及部署方式参数

##### （4）K8S_API_SERVER
【参数说明】部署应用的K8S环境名称  
【使用指导】  
  1）格式要求【tag名称:tag】，tag名称可以自定义，推荐使用有意义的值；tag要与持续交付中心slave端tag一致；  
  2）可以配置多个【tag名称:tag,tag名称2:tag2】，可以将应用部署到对应tag的k8s环境；  

##### （5）ONLY_DEPLOY
【参数说明】是否仅执行部署  
【使用指导】  
  1）选择true：不进行编译打包，参数选项：NEED_SCA、NEED_JUNIT不生效；  
  2）需在执行过程选择chart版本；  
  3）false会执行从源码到部署。  

##### （6）NEED_SERVICE_DEBUG
  【参数说明】部署的后端应用是否需要开启服务调试    
  【使用指导】是否需要服务调试。true表示需要，false表示不需要。默认为false，表示当前服务不开启服务调试。    

##### （7）NODE_LABEL
【参数说明】服务布署节点标签设置；  
【使用指导】  
  1）统一规划业务产品标识[key]；  
  2）运维者在k8s集群节点上添加主机标签，标签格式为cloud.app.yss.[key] = business；  
  3）NODE_LABEL参数填入“key”值；  
  4）默认NODE_LABEL=”demo”。  

##### （8）EXTERNAL_STATIC_RESOURCE_PATH  
【参数说明】前端项目使用容器外资源目录；  
【使用指导】  
前端项目如果需要使用容器外资源，需要执行以下配置：  
  1）该参数指定主机节点中静态资源的存放目录；  
  2）nginx配置配置文件中需要指向用户存放静态资源的目录，该参数与配置文件中配置的静态资源访问目录一致；  
  3）该配置默认为空，表示不使用容器外资源。  

#### 2.1.4 部署前测试参数
##### （9）NEED_SCA  
【参数说明】是否需要执行静态代码检查，true需要，false不需要；  

##### （10） NEED_JUNIT
【参数说明】是否需要执行单元测试，true需要，false不需要；仅适用于后端项目；  

##### （11） NEED_IMAGE_SCAN
【参数说明】是否需要执行打包的镜像扫描，true需要，false不需要。

#### 2.1.5 部署后测试参数

##### （12）通用参数
* **sleepTime** ：应用部署完到启动测试的等待时间，单位秒，例如：sleepTime=60；
* **TEST_SERVICE**（仅适用于后端项目）
【参数说明】接口测试，性能测试，安全测试使用的服务名称；  
【使用指导】  
  1）可以使用gateway网关服务名称，或者服务自身的名字；  
  2）可以在运营实施中心查看traefik网关，gateway网关组件或者应用的服务名称。  

##### （13）接口测试参数（仅适用于后端项目）
* **NEED_API_TEST**：是否需要执行接口测试，true需要，false不需要；  

* **APITestCase**：在流水线上接收本次要执行的接口测试文件的参数，这个参数值需要手工填写，填写时测试文件之间以英文','分割。这个参数可以接收2种类型的测试用例文件

  * 根据测试用例模板编写的excel的测试用例文件，例 如：“APITestCase1.xlsx,APITestCase2.xlsx”；

  * 根据测试用例模板编写的excel的测试用例文件在本地根据自动化测试插件（cicd-autotest-plugin.jar）生成的jmx文件，例如：“APITestCase.jmx”，并且2类文件可同时在流水线上测试：APITestCase1.xlsx,APITestCase.jmx

##### （14） 性能测试参数（仅适用于后端项目）
* **NEED_PM_TEST**：是否需要执行性能测试，true需要，false不需要；
* **pmCaseFile**：在流水线上接收本次要执行的性能测试文件的参数，这个参数值需要手工填写，填写时测试文件之间以英文','分割。这个参数可以接收2种类型的测试用例文件

  * 根据测试用例模板编写的excel的测试用例文件，例 如：“PerformanceTest1.xlsx,PerformanceTest2.xlsx”；

  * 根据测试用例模板编写的excel的测试用例文件在本地根据自动化测试插件（cicd-autotest-plugin.jar）生成的jmx文件，例如：“PerformanceTest.jmx”，并且2类文件可同时在流水线上测试：PerformanceTest1.xlsx,PerformanceTest.jmx  

##### （15）安全测试参数
* **NEED_SAFE_TEST**：是否需要执行ZAP安全测试，true需要，false不需要；  
* **ATK_LEVEL**：执行ZAP安全测试的等级，等级可选值为：High, Medium, Low。  

#### 2.1.6 私有库参数
##### （16） NRM_LIB（适用于前端项目）  
【参数说明】  

1）前端项目自定义npm私服地址，例如：npm:http://192.168.199.179:5001；    

2） 应用可独立配置npm私服，也可以在 CommEnv.groovy文件中配置公共npm私服地址；

3）默认为空，且当CommEnv.groovy中私服配置也为空时，表示通过外网获取依赖；    

4）可配置多个私服地址，使用英文逗号【,】分隔填入的地址。  

#### 2.1.7 运行参数
##### （17）DOCKERGROUP
【参数说明】产物仓库的项目名；

##### （18） REPLICAS
【参数说明】服务副本数量，例如：REPLICAS = "1"；

##### （19） NAMESPACE
【参数说明】k8s命名空间；默认NAMESPACE = "bcloud"，表示应用默认部署到bcloud命名空间；

##### （20） GROUP
【参数说明】用于区分不同业务线应用同名而设置的前缀，例如：GROUP = "com.yss"；  

##### （21） RELEASEDIR（适用于前端项目）
【参数说明】前端项目编译后静态资源的目录，例如：RELEASEDIR = "dist"；不建议修改；

##### （22）CONTAINER_JVM_FLAGS（适用于后端项目）
【参数说明】后端项目JVM运行参数，如果为空值则使用默认配置；    

##### （23）TEST_SERVICE    
【参数说明】后端项目执行接口测试，性能测试，安全测试使用的服务名称（前端项目仅涉及安全测试）。
参数范围：gateway网关服务名称或者服务自身的服务名。    

##### （24）HEALTH_TEST_PATH    
【参数说明】执行就绪检查的接口    
> 部署的应用中可以用于执行就绪检查的访问接口。    
> 前端项目为根路径，即：“/”；    
> 后端项目为可用的路径，用户自定义。    

##### （25）CONFIG_CENTER_PROFILE
【参数说明】  
  1）指向配置中心的配置文件标识；  
  2）配置中心文件名为appname-[key].yaml文件，则此处填入key值，例如:CONFIG_CENTER_PROFILE=”key“；   
  3）默认为空，表示使用与流水线类型相同的标识。    

#### 2.1.8 访问方式参数  

​		应用的访问包括域名方式和IP(虚拟IP)方式。

* 公共参数对于域名和IP方式访问都需要配置;  

* 在开发、测试、发布和生产过程中都可以使用IP和域名方式访问服务。  

##### （26）公共参数
* **CONTAINERPORT1**  
【参数说明】应用访问的端口  
【使用指导】  
  1）后端项目对应**http**端口，覆盖bootstrap.yaml配置文件的**server.port**参数；  
  2）前端项目对应**http**端口；  
  3）推荐使用**40000-50000**端口。  
【注意事项】需要与CONTAINERPORT2使用不同的端口。  

* **CONTAINERPORT2**  
【参数说明】应用访问的端口；  
【使用指导】  
  1）后端项目对应**tcp**端口，覆盖bootstrap.yaml配置文件的**websocket.port**参数；  
  2）前端项目对应**https**访问端口；  
  3）推荐使用**40000-50000**端口。  
【注意事项】需要与CONTAINERPORT1使用不同的端口。  

##### （27）域名方式访问

* **MYDOMAIN1**
【参数说明】部署应用对应的域名  
【使用指导】如果使用https方式访问，且应用使用独立证书（自定义证书）时，需要与k8s集群中导入的证书绑定域名一致；  
* **MYDOMAIN2**
【参数说明】前端项目访问的域名；后端项目扩展自定义监听端口使用的域名 
【使用指导】
 1）前端项目使用https协议访问时的域名，推荐和MYDOMAIN1相同；
 2）后端项目使用扩展自定义监听端口（CONTAINERPORT2）时使用的域名，推荐使用与MYDOMAIN1不同的域名；
 3）后端项目如果需要使用https方式访问，且使用应用独立证书，需要与k8s集群中导入的证书绑定的域名一致。  

* **SECRETNAME1**
【参数说明】应用独立证书名称；  
【使用指导】  
 1）前端项目时置空；
 2）后端项目不使用证书时，为空值；
 3）后端项目使用应用自签名证书时，需要将证书导入集群，并配置该参数，引用导入证书的名称。（导入证书方法参考《运营实施中心使用手册》5.5.2章节。）
 4）后端项目使用泛域名证书时，不配置该参数，为空值。
  
* **SECRETNAME2**
【参数说明】应用独立证书名称；  
【使用指导】  
1）前后端项目使用自定义自签名证书时，需要将证书导入集群，并配置该参数，引用导入证书的名称。（导入证书方法参考《运营实施中心使用手册》5.5.2章节。）
2）使用云平台自动生成共有证书时，不配置该参数，为空值。
3）使用公有证书时，不配置该参数，为空值。
4）前端项目使用https方式访问时，传入在k8s集群中导入的证书名称；前端项目可以通过IP:PORT方式、域名方式访问；
【注意】后端项目推荐不使用证书访问，或者使用泛域名证书访问。
##### （28）IP:PORT方式访问

* **NEED_IPVS_LOADBALANCE**
【参数说明】是否需要开启ipvs负载均衡
【使用指导】默认为true，表示开启ipvs负载均衡。

* **LOADBALANCE_VIP**
【参数说明】ipvs负载均衡时访问应用的虚拟IP
【使用指导】  
1）当NEED_IPVS_LOADBALANCE选择为true时生效。
2）默认为空值，此时系统会自动分配虚拟IP；
3）如果用户需要使用固定的IP，需要配置该参数。
【注意】用户配置该参数时，需要在“运营实施中心”查看可用的虚拟IP。  

### 2.2 公共参数（cicd-config/CommEnv.groovy）

#### 2.2.1 凭据参数
##### （1）产物仓库参数
* **HARBOR_CRED**：持续交付中心上产物仓库登录凭据；建议使用默认值，因为持续交付中心已经预置了该参数；  
* **HARBOR_NAME**：产物仓库的域名，与运营实施中心配置的镜像库域名一致；  
* **HARBOR_SSH**：产物仓库访问的协议，可选值为**http**或者**https**；
* **IMAGE_PULL_SECRET**：产物仓库凭据名称，与运营实施中心配置的镜像库凭证名称一致。  

##### （2）静态检查参数
* **SONAR_CRED**：持续交付中心静态分析服务端登录凭据。使用默认值，因为持续交付中心已经预置了该参数；  
* **SONAR_SERVER** ：持续交付中心上配置的sonar的组件的名称，默认为“sonarqube”，不建议修改。  

#### 2.2.2 NPM私服参数

##### （3）NRM_LIB （适用于前端项目）
【参数说明】公共npm私服，例如："lugia:http://192.168.199.80:5001"  。该值会被应用服务配置的私服参数（NRM_LIB）覆盖。

#### 2.2.3 单元测试参数
##### （4） 单元测试参数
* **classCoverage**：单元测试类覆盖率，例如：classCoverage = "90"；  
* **methodCoverage**：单元测试方法覆盖率，例如：methodCoverage = "90"；  
* **branchCoverage**：单元测试分支覆盖率，例如：branchCoverage = "90"；  
* **lineCoverage**：单元测试行覆盖率，例如：lineCoverage = "90"。  

#### 2.2.4 通知参数

##### （5）邮件收件人参数
* **MAILTO_DEV**：开发流水线邮件接收人；  

* **MAILTO_TEST**：测试流水线邮件接收人；  

* **MAILTO_RELEASE**：发布流水线邮件接收人；  

* **MAILTO_PRO**：生产流水线邮件接收人。 

##### （6）企业微信接收人参数
* **WEIXIN_DEV**：开发流水线微信消息接收机器人webhook；  
* **WEIXIN_TEST**：测试流水线微信消息接收机器人webhook；  
* **WEIXIN_RELEASE**：发布流水线微信消息接收机器人webhook；  
* **WEIXIN_PRO**：生产流水线微信消息接收机器人webhook。  
【注意事项】可以配置多个企业微信接收机器人的webhook，用|分隔，如"webhook1|webhook2"，遵循企业微信官方API说明。  

##### （7）钉钉消息接收人参数
* **DINGTALK_TO_DEV**：开发流水线钉钉消息接收机器人webhook和密钥；  
* **DINGTALK_TO_TEST**：测试流水线钉钉消息接收机器人webhook和密钥；  
* **DINGTALK_TO_RELEASE**：发布流水线钉钉消息接收机器人webhook和密钥；  
* **DINGTALK_TO_PRO**：生产流水线钉钉消息接收机器人webhook和密钥。  
【注意事项】钉钉通信设置，webhook和密钥之间用“|”分割，一个webhook链接和对应的密钥为一组；可以配置多个钉钉机器人，每组配置之间用“,”分隔，例如“例如“[webhook1]|[secret1],[webhook2]|[secret2],......”。  

#### 2.2.5 日志参数

##### （8）日志参数
* **TAG_COUNT**：发布流水线构建时获取提交记录的tag数量；表示生成的记录包含多少个tag间隔，默认为1；  
* **DAY_COUNT**：开发, 测试流水线构建时获取提交记录的天数；默认为1天，表示获取当前时间前一天的提交记录。  

### 2.3 公有库（cicd-center）参数（resources/com/yss/cicd/env/commonenv.sh）
#### 2.3.1 docker参数
##### （1）DOCKER_MEMORY
【参数说明】docker容器使用内存，默认为1024Mi；  

##### （2）DOCKER_CPU
【参数说明】使用CPU数量，默认为1；  

#### 2.3.2 通知消息参数

##### （3）MAILFROM
【参数说明】发件管理员邮箱名称；  
【使用指导】该参数需要和Jenkins “系统设置”中配置的发件方地址一致；  

### 2.3 创建流水线时参数设置
在v3.2.3版本云平台中，推荐使用新建任务的方式创建流水线。参考《持续交付中心使用手册》“4.2.1 新建任务”章节。配置参数如下：
* **Repository URL**：项目配置库（cicd-config）地址，格式为：http://[ip:port]/url.git;  
* **Branches to build**： 项目配置库（cicd-config）分支；   
* **Credentials**：从项目仓库获取项目配置库代码的凭据ID，在持续交付中心“凭据管理”中配置，此处为凭据的ID；
* **脚本路径**：项目配置库（cicd-config）中配置文件脚本的相对路径。